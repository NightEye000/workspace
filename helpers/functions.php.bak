<?php
/**
 * Helper Functions
 */

/**
 * Send JSON Response
 */
function jsonResponse($data, $statusCode = 200) {
    http_response_code($statusCode);
    header('Content-Type: application/json');
    echo json_encode($data);
    exit;
}

/**
 * Hash Password
 */
function hashPassword($password) {
    return password_hash($password, PASSWORD_DEFAULT);
}

/**
 * Verify Password
 */
function verifyPassword($password, $hash) {
    return password_verify($password, $hash);
}

/**
 * Generate Avatar URL
 */
function generateAvatar($seed) {
    return "https://api.dicebear.com/7.x/avataaars/svg?seed=" . urlencode($seed);
}

/**
 * Sanitize Input
 */
function sanitize($input) {
    if (is_array($input)) {
        return array_map('sanitize', $input);
    }
    return htmlspecialchars(trim($input), ENT_QUOTES, 'UTF-8');
}

/**
 * Get Current User from Session
 */
function getCurrentUser() {
    if (session_status() === PHP_SESSION_NONE) {
        session_start();
    }
    return $_SESSION['user'] ?? null;
}

/**
 * Check if User is Admin
 */
function isAdmin() {
    $user = getCurrentUser();
    return $user && $user['role'] === 'Admin';
}

/**
 * Check if User is Logged In
 */
function isLoggedIn() {
    return getCurrentUser() !== null;
}

/**
 * Check Access Permission
 * Admin can access all, Staff can only access their own data
 */
function canAccessStaff($staffId) {
    $user = getCurrentUser();
    if (!$user) return false;
    if ($user['role'] === 'Admin') return true;
    return $user['id'] == $staffId;
}

/**
 * Format Time to HH:MM
 */
function formatTime($time) {
    return date('H:i', strtotime($time));
}

/**
 * Format Date to Indonesian
 */
function formatDateIndonesian($date) {
    $days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
    $months = ['', 'Januari', 'Februari', 'Maret', 'April', 'Mei', 'Juni', 
               'Juli', 'Agustus', 'September', 'Oktober', 'November', 'Desember'];
    
    $timestamp = strtotime($date);
    $dayIndex = date('w', $timestamp);
    $day = date('d', $timestamp);
    $monthIndex = (int)date('m', $timestamp);
    $year = date('Y', $timestamp);
    
    return $days[$dayIndex] . ', ' . $day . ' ' . $months[$monthIndex] . ' ' . $year;
}

/**
 * Calculate Minutes Until Time
 */
function minutesUntil($targetTime, $baseTime = null) {
    $base = $baseTime ? strtotime($baseTime) : time();
    $target = strtotime($targetTime);
    return round(($target - $base) / 60);
}

/**
 * Get Day Name from Index
 */
function getDayName($index) {
    $days = ['Minggu', 'Senin', 'Selasa', 'Rabu', 'Kamis', 'Jumat', 'Sabtu'];
    return $days[$index] ?? '';
}

/**
 * Generate Unique ID
 */
function generateUID($prefix = '') {
    return $prefix . uniqid() . bin2hex(random_bytes(4));
}

/**
 * Log Activity (for debugging)
 */
function logActivity($message, $data = []) {
    $logFile = __DIR__ . '/../logs/activity.log';
    $logDir = dirname($logFile);
    
    if (!is_dir($logDir)) {
        mkdir($logDir, 0755, true);
    }
    
    $entry = date('Y-m-d H:i:s') . ' - ' . $message;
    if (!empty($data)) {
        $entry .= ' - ' . json_encode($data);
    }
    $entry .= PHP_EOL;
    
    file_put_contents($logFile, $entry, FILE_APPEND);
}

/**
 * Generate CSRF Token
 */
function generateCSRFToken() {
    if (session_status() === PHP_SESSION_NONE) {
        session_start();
    }
    if (empty($_SESSION['csrf_token'])) {
        $_SESSION['csrf_token'] = bin2hex(random_bytes(32));
    }
    return $_SESSION['csrf_token'];
}

/**
 * Get CSRF Token
 */
function getCSRFToken() {
    if (session_status() === PHP_SESSION_NONE) {
        session_start();
    }
    return $_SESSION['csrf_token'] ?? generateCSRFToken();
}

/**
 * Verify CSRF Token
 */
function verifyCSRFToken() {
    $headers = apache_request_headers();
    $token = $headers['X-CSRF-Token'] ?? $_SERVER['HTTP_X_CSRF_TOKEN'] ?? '';
    
    if (empty($token) || $token !== getCSRFToken()) {
        jsonResponse(['success' => false, 'message' => 'Invalid CSRF Token'], 403);
    }
}

